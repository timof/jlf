#!/bin/bash
#
# htmlDefuse (Timo Felbinger, 2011 .. 2013)
#
# this script is an ExtFilter for apache:
#
# the script will gobble all lines up to and including a line starting with
#   extfilter: <keyword>
# where <keyword> selects one of the following filters:
#
# - null: a null-filter, which just passes all lines between a starter line matching
#
      START_PATTERN=$'^\x14\x14\x14$'
#
#   and a stopper line matching
#
      STOP_PATTERN=$'^\x13\x13\x13$'
#
#   the escape pattern
#
      ESCAPE_PATTERN=$'^\x15\x15\x14'
#
#   will be removed from all printed lines which can be used for escaping.
#
# - html: an outfilter for html which, in addition to the above, will
#   * quote HTML "hot" characters (', ", <, > and &) as  &...; -entities
#   * convert ASCII characters 0x11...0x15 to hot characters ' ... & 
#
# - xxd: identical to null but feed output lines through xxd -r -p to make filtering binary-safe
#
# the html filter is supposed to prevent css attacks in web applications:
# - reject characters 0x11...0x15 in user (text) input (they serve no useful purpose
#   there, and can be easily and unambiguously detected in an utf8 input stream)
# - use 0x11...0x15 to represent ' ... & in HTML output produced from cgi scripts
# - configure apache to use this script as output filter (see ExtFilterDefine)
#
# it may be a good idea to include a plain-text hint to switch on this filter in html
# output before the extfilter line.
# 

extfilter='error'
while read tag f; do
  if [ "$tag" = 'extfilter:' ] ; then
    extfilter="$f"
    break
  fi
done


case "$extfilter" in
  error )
    echo "fatal error: script died early and no valid output was produced - sorry!";
  ;;
  null )
    sed -n -e "
      :skip
        /$START_PATTERN/b print
        n
        b skip
      :print
        n
        /$STOP_PATTERN/b skip
        s/$ESCAPE_PATTERN//
        p
        b print
    "
  ;;
  xxd )
    sed -n -e "
      :skip
        /$START_PATTERN/b print
        n
        b skip
      :print
        n
        /$STOP_PATTERN/b skip
        s/$ESCAPE_PATTERN//
        p
        b print
    " | xxd -r -p
  ;;
  html )
    sed -n -e "
      :skip
        /$START_PATTERN/b print
        n
        b skip
      :print
        n
        /$STOP_PATTERN/b skip
        s/$ESCAPE_PATTERN//
        s/&/\&amp;/g
        s/'/\&#039;/g
        s/\"/\&quot;/g
        s/</\&lt;/g
        s/>/\&gt;/g
        p
        b print
    " | tr $'\x11\x12\x13\x14\x15' "'\"<>&"
  ;;
  * )
    echo "unsupported extfilter: $extfilter"
  ;;
esac

